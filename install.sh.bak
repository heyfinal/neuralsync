#!/bin/bash

# NeuralSync One-Click Installer
# Auto-detects system, installs dependencies, configures AI CLIs
# Supports: claude-code, codexcli, autopilot, aider, gemini-cli

set -e

# Error handling for piped execution
trap 'echo "âŒ Installation failed at line $LINENO. Check the error above." >&2; exit 1' ERR

# Handle interrupted installation  
trap 'echo "âš ï¸ Installation interrupted. You can re-run the installer to continue." >&2; exit 1' INT TERM

# Detect if running via curl pipe or interactive
INTERACTIVE_MODE=true
if [ "${NEURALSYNC_BATCH:-}" = "true" ] || [ ! -t 0 ] && [ ! -t 1 ]; then
    INTERACTIVE_MODE=false
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
echo -e "${CYAN}"
cat << 'EOF'
:::.    :::..,::::::  ...    ::::::::::..    :::.      :::     
`;;;;,  `;;;;;;;''''  ;;     ;;;;;;;``;;;;   ;;`;;     ;;;     
  [[[[[. '[[ [[cccc  [['     [[[ [[[,/[[['  ,[[ '[[,   [[[     
  $$$ "Y$c$$ $$""""  $$      $$$ $$$$$$c   c$$$cc$$$c  $$'     
  888    Y88 888oo,__88    .d888 888b "88bo,888   888,o88oo,.__
  MMM     YM """"YUMMM"YmmMMMM"" MMMM   "W" YMM   ""` """"YUMMM
                 .::::::..-:.     ::-.:::.    :::.  .,-:::::   
                ;;;`    ` ';;.   ;;;;'`;;;;,  `;;;,;;;'````'   
                '[==/[[[[,  '[[,[[['    [[[[[. '[[[[[          
                  '''    $    c$$"      $$$ "Y$c$$$$$          
                 88b    dP  ,8P"`       888    Y88`88bo,__,o,  
                  "YMmMY"  mM"          MMM     YM  "YUMMMMMP"

        NeuralSync One-Click Installer v1.0
        Distributed AI Memory & Orchestration Platform
EOF
echo -e "${NC}"

# Global variables
OS_TYPE=""
INSTALL_DIR="$HOME/.neuralsync"
VENV_DIR="$INSTALL_DIR/venv"
DETECTED_AIS=""
DOCKER_AVAILABLE=false
HOMEBREW_AVAILABLE=false
USER_NAME=""
NAS_MOUNT_POINT=""
NAS_IP=""
NAS_USERNAME=""
NAS_PASSWORD=""
SCAN_AI_CONFIGS=false
AI_CONFIG_FILES=""
NEURALSYNC_ADMIN_USER=""
NEURALSYNC_ADMIN_PASS=""
NEURALSYNC_SYNC_MODE=""

# Logging function
log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

success() {
    echo -e "${PURPLE}[SUCCESS]${NC} $1"
}

# Detect operating system
detect_os() {
    log "Detecting operating system..."
    case "$(uname -s)" in
        Linux*)     OS_TYPE="Linux";;
        Darwin*)    OS_TYPE="macOS";;
        CYGWIN*)    OS_TYPE="Windows";;
        MINGW*)     OS_TYPE="Windows";;
        *)          OS_TYPE="Unknown";;
    esac
    log "Detected OS: $OS_TYPE"
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Detect available package managers
detect_package_managers() {
    log "Detecting package managers..."
    
    if command_exists brew; then
        HOMEBREW_AVAILABLE=true
        log "Homebrew detected"
    fi
    
    if command_exists docker; then
        DOCKER_AVAILABLE=true
        log "Docker detected"
    fi
}

# Install system dependencies
install_system_dependencies() {
    log "Installing system dependencies..."
    
    case $OS_TYPE in
        "macOS")
            # Install Homebrew if not available
            if ! $HOMEBREW_AVAILABLE; then
                log "Installing Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                export PATH="/opt/homebrew/bin:$PATH"
                HOMEBREW_AVAILABLE=true
            fi
            
            # Install Docker if not available
            if ! $DOCKER_AVAILABLE; then
                log "Installing Docker Desktop..."
                brew install --cask docker
                if [ -t 0 ]; then
                    warn "Please start Docker Desktop manually and return to continue"
                    read -p "Press Enter when Docker is running..." < /dev/tty
                else
                    warn "Docker Desktop installed but not started - run 'open /Applications/Docker.app' manually"
                    log "Continuing installation without Docker for now..."
                fi
            fi
            
            # Install Python and other dependencies
            brew install python3 git curl wget
            ;;
            
        "Linux")
            # Detect Linux distribution
            if [ -f /etc/debian_version ]; then
                log "Installing dependencies for Debian/Ubuntu..."
                sudo apt update
                sudo apt install -y python3 python3-pip python3-venv git curl wget docker.io docker-compose
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker $USER
            elif [ -f /etc/redhat-release ]; then
                log "Installing dependencies for RHEL/CentOS..."
                sudo yum install -y python3 python3-pip git curl wget docker docker-compose
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker $USER
            fi
            DOCKER_AVAILABLE=true
            ;;
            
        *)
            error "Unsupported operating system: $OS_TYPE"
            exit 1
            ;;
    esac
}

# Get user information and preferences
get_user_preferences() {
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${PURPLE}ðŸŽ¯ NeuralSync Personal Configuration${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Check if we should prompt for user input
    if [ "$INTERACTIVE_MODE" = "true" ]; then
        # Terminal input available - interactive mode
        echo -e "${BLUE}ðŸ‘‹ Personal Information${NC}"
        echo "NeuralSync AIs will address you personally by name for better interaction."
        read -p "What's your name? (e.g., Daniel, Sarah): " USER_NAME < /dev/tty
        if [ -z "$USER_NAME" ]; then
            USER_NAME="User"
        fi
        log "Hello $USER_NAME! Setting up personalized AI experience..."
        echo ""
        
        # NeuralSync admin credentials
        echo -e "${BLUE}ðŸ” Admin Account Setup${NC}"
        echo "Create admin credentials for NeuralSync configuration and memory access."
        read -p "Choose admin username (default: admin): " admin_user < /dev/tty
        NEURALSYNC_ADMIN_USER=${admin_user:-admin}
        
        while true; do
            read -s -p "Create admin password: " admin_pass1 < /dev/tty
            echo ""
            read -s -p "Confirm admin password: " admin_pass2 < /dev/tty
            echo ""
            if [ "$admin_pass1" = "$admin_pass2" ]; then
                NEURALSYNC_ADMIN_PASS="$admin_pass1"
                break
            else
                error "Passwords don't match. Please try again."
            fi
        done
        success "Admin account configured for $NEURALSYNC_ADMIN_USER"
        echo ""
    else
        # Piped mode - use defaults
        warn "Running in piped mode - using default configuration"
        USER_NAME="User"
        NEURALSYNC_ADMIN_USER="admin"
        NEURALSYNC_ADMIN_PASS="neuralsync123"
        log "Hello $USER_NAME! Setting up personalized AI experience with defaults..."
        log "Default admin account: $NEURALSYNC_ADMIN_USER (password: neuralsync123)"
        echo ""
    fi
    
    # Sync Mode Configuration
    echo -e "${BLUE}ðŸ”„ Memory Sync Mode Configuration${NC}"
    echo "Choose how NeuralSync handles memory across devices:"
    echo ""
    echo "1) Real-time Sync - Continuous synchronization across all devices"
    echo "2) Manual Handoff - Export/import memory bundles between devices"
    echo "3) Hybrid Mode - Real-time sync with manual handoff capability"
    echo ""
    
    if [ -t 0 ]; then
        read -p "Select sync mode (1-3, default: 3): " sync_mode < /dev/tty
    else
        sync_mode=3
        log "Using default sync mode: Hybrid"
    fi
    
    case ${sync_mode:-3} in
        1)
            NEURALSYNC_SYNC_MODE="realtime"
            log "Real-time sync mode selected - memories sync continuously"
            ;;
        2)
            NEURALSYNC_SYNC_MODE="handoff"
            log "Manual handoff mode selected - memories transfer via export/import"
            ;;
        *)
            NEURALSYNC_SYNC_MODE="hybrid"
            log "Hybrid mode selected - both real-time sync and handoff available"
            ;;
    esac
    echo ""
    
    # NAS Configuration
    echo -e "${BLUE}ðŸ’¾ Network Storage Configuration${NC}"
    echo "NeuralSync can use network storage for cold memory archival and backup."
    if [ "$NEURALSYNC_SYNC_MODE" = "realtime" ] || [ "$NEURALSYNC_SYNC_MODE" = "hybrid" ]; then
        echo -e "${YELLOW}Note: NAS is recommended for real-time sync mode${NC}"
    fi
    echo ""
    
    if [ -t 0 ]; then
        read -p "Do you want to configure NAS storage? (y/N): " configure_nas < /dev/tty
    else
        configure_nas="n"
        log "Skipping NAS configuration in piped mode"
    fi
    if [[ $configure_nas =~ ^[Yy]$ ]]; then
        echo ""
        echo "Choose NAS configuration method:"
        echo "1) Direct mount point (e.g., /Volumes/MyNAS, /mnt/nas)"
        echo "2) IP address with credentials"
        
        if [ -t 0 ]; then
            read -p "Enter choice (1-2): " nas_choice < /dev/tty
        else
            nas_choice=1
            log "Using default NAS method: mount point"
        fi
        
        case $nas_choice in
            1)
                if [ -t 0 ]; then
                    read -p "Enter NAS mount point path: " NAS_MOUNT_POINT < /dev/tty
                    if [ ! -d "$NAS_MOUNT_POINT" ]; then
                        warn "Mount point $NAS_MOUNT_POINT does not exist. You can configure this later."
                    else
                        success "NAS mount point configured: $NAS_MOUNT_POINT"
                    fi
                else
                    NAS_MOUNT_POINT="/Volumes/NAS"
                    log "Default NAS mount point: $NAS_MOUNT_POINT (configure later if needed)"
                fi
                ;;
            2)
                if [ -t 0 ]; then
                    read -p "Enter NAS IP address: " NAS_IP < /dev/tty
                    read -p "Enter NAS username: " NAS_USERNAME < /dev/tty
                    read -s -p "Enter NAS password: " NAS_PASSWORD < /dev/tty
                    echo ""
                    success "NAS credentials configured for $NAS_IP"
                else
                    log "NAS IP configuration requires interactive mode - skipping"
                fi
                ;;
        esac
    else
        log "Skipping NAS configuration (can be added later)"
    fi
    echo ""
    
    # AI Config File Scanning
    echo -e "${BLUE}ðŸ” AI Configuration Discovery${NC}"
    echo "NeuralSync can scan your system for existing AI configuration files"
    echo "(like .claude.md, .cursor-rules, .aider.conf.yml, etc.) to create"
    echo "a comprehensive base memory and prime directive system."
    echo ""
    echo -e "${YELLOW}This will scan common locations like:${NC}"
    echo "  â€¢ ~/.claude.md, ~/.claude/"
    echo "  â€¢ ~/.cursor/, .cursor-rules"
    echo "  â€¢ ~/.aider.conf.yml"
    echo "  â€¢ ~/.config/ directories"
    echo "  â€¢ Project-specific AI config files"
    echo ""
    if [ -t 0 ]; then
        read -p "Scan and compile AI configuration files? (y/N): " scan_consent < /dev/tty
        if [[ $scan_consent =~ ^[Yy]$ ]]; then
            SCAN_AI_CONFIGS=true
            log "Will scan for AI configuration files"
        else
            log "Skipping AI config file scanning"
        fi
    else
        SCAN_AI_CONFIGS=true
        log "Auto-enabling AI config scanning in piped mode"
    fi
    echo ""
}

# Scan for existing AI configuration files
scan_ai_configurations() {
    if [ "$SCAN_AI_CONFIGS" = false ]; then
        return
    fi
    
    log "Scanning filesystem for AI configuration files..."
    
    # Define common AI config file patterns
    local config_patterns=(
        "$HOME/.claude.md"
        "$HOME/.claude/CLAUDE.md"
        "$HOME/.claude/config.json"
        "$HOME/.cursor-rules"
        "$HOME/.cursor/rules.md"
        "$HOME/.aider.conf.yml"
        "$HOME/.aider/config.yml"
        "$HOME/.config/cursor/"
        "$HOME/.config/aider/"
        "$HOME/.config/claude/"
        "$HOME/.codeium/config.json"
        "$HOME/.copilot/config.yml"
        "$HOME/.chatgpt/config.json"
        "$HOME/CLAUDE.md"
        "$HOME/AI_INSTRUCTIONS.md"
        "$HOME/PROJECT_INSTRUCTIONS.md"
        "$HOME/.ai/"
        "$HOME/.llm/"
    )
    
    # Find files in common project locations
    local project_patterns=(
        "CLAUDE.md"
        ".claude.md" 
        ".cursor-rules"
        ".aider.conf.yml"
        "AI_INSTRUCTIONS.md"
        "PROJECT_CONTEXT.md"
        ".ai/instructions.md"
        ".github/ai-instructions.md"
    )
    
    AI_CONFIG_FILES=""
    
    # Scan home directory patterns
    for pattern in "${config_patterns[@]}"; do
        if [ -f "$pattern" ] || [ -d "$pattern" ]; then
            AI_CONFIG_FILES="$AI_CONFIG_FILES\n$pattern"
            log "Found: $pattern"
        fi
    done
    
    # Scan common development directories for project-specific configs
    local dev_dirs=("$HOME/Desktop" "$HOME/Documents" "$HOME/Projects" "$HOME/Code" "$HOME/Development")
    for dev_dir in "${dev_dirs[@]}"; do
        if [ -d "$dev_dir" ]; then
            for pattern in "${project_patterns[@]}"; do
                find "$dev_dir" -name "$pattern" -type f 2>/dev/null | while read -r file; do
                    AI_CONFIG_FILES="$AI_CONFIG_FILES\n$file"
                    log "Found project config: $file"
                done
            done
        fi
    done
    
    # Also check if we're in a git repository with AI configs
    local current_dir="$PWD"
    while [ "$current_dir" != "/" ]; do
        if [ -d "$current_dir/.git" ]; then
            for pattern in "${project_patterns[@]}"; do
                if [ -f "$current_dir/$pattern" ]; then
                    AI_CONFIG_FILES="$AI_CONFIG_FILES\n$current_dir/$pattern"
                    log "Found git project config: $current_dir/$pattern"
                fi
            done
            break
        fi
        current_dir="$(dirname "$current_dir")"
    done
    
    if [ ! -z "$AI_CONFIG_FILES" ]; then
        local count=$(echo -e "$AI_CONFIG_FILES" | grep -c .)
        success "Found $count AI configuration files"
    else
        warn "No AI configuration files found"
    fi
}

# Compile AI configurations into base memory
compile_base_memory() {
    if [ "$SCAN_AI_CONFIGS" = false ] || [ -z "$AI_CONFIG_FILES" ]; then
        return
    fi
    
    log "Compiling AI configurations into base memory system..."
    
    local base_memory_file="$INSTALL_DIR/config/base_memory.md"
    local prime_directive_file="$INSTALL_DIR/config/prime_directive.md"
    
    # Create base memory file
    cat > "$base_memory_file" << EOF
# NeuralSync Base Memory System
# Compiled from user's existing AI configurations
# Generated: $(date)
# User: $USER_NAME

## User Profile
**Name**: $USER_NAME
**System**: $(uname -a)
**Install Date**: $(date)
**NAS Configuration**: ${NAS_MOUNT_POINT:-$NAS_IP}

## Compiled AI Configurations

EOF
    
    # Create prime directive file
    cat > "$prime_directive_file" << EOF
# NeuralSync Prime Directive
# Core instructions compiled from user's AI configurations
# User: $USER_NAME

## Core Identity
You are part of the NeuralSync AI orchestration platform serving $USER_NAME.
You have access to persistent memory, cross-AI communication, and comprehensive context.

## User Preferences (Compiled from existing configs)

EOF
    
    # Process each found configuration file
    echo -e "$AI_CONFIG_FILES" | while read -r config_file; do
        if [ -f "$config_file" ] && [ -s "$config_file" ]; then
            log "Processing: $config_file"
            
            echo "### Configuration from: \`$config_file\`" >> "$base_memory_file"
            echo "" >> "$base_memory_file"
            echo "\`\`\`" >> "$base_memory_file"
            cat "$config_file" >> "$base_memory_file"
            echo "" >> "$base_memory_file"
            echo "\`\`\`" >> "$base_memory_file"
            echo "" >> "$base_memory_file"
            
            # Extract key instructions for prime directive
            if grep -qi "instruction\|rule\|directive\|guideline\|preference" "$config_file"; then
                echo "#### From \`$(basename "$config_file")\`:" >> "$prime_directive_file"
                grep -i "instruction\|rule\|directive\|guideline\|preference" "$config_file" | head -10 >> "$prime_directive_file"
                echo "" >> "$prime_directive_file"
            fi
        fi
    done
    
    # Add NeuralSync-specific directives
    cat >> "$prime_directive_file" << EOF

## NeuralSync Core Directives

1. **Personal Address**: Always address the user as "$USER_NAME"
2. **Memory Integration**: Utilize persistent memory for context continuity
3. **Cross-AI Collaboration**: Coordinate with other AI agents when beneficial
4. **User Autonomy**: Respect user preferences from compiled configurations
5. **Context Awareness**: Maintain awareness of project context and user goals

## Collaboration Guidelines

When working with other AIs in the NeuralSync network:
- Share relevant context through the memory system
- Avoid duplicate work by checking existing memory
- Coordinate task delegation based on AI strengths
- Maintain consistent personality and preferences for $USER_NAME

EOF
    
    success "Base memory system compiled with user configurations"
    log "Base memory: $base_memory_file"
    log "Prime directive: $prime_directive_file"
}

# Detect available AI CLIs
detect_ai_clis() {
    log "Detecting available AI CLIs..."
    DETECTED_AIS=""
    
    # Claude Code
    if command_exists claude; then
        DETECTED_AIS="$DETECTED_AIS claude-code"
        log "âœ“ Claude Code detected"
    fi
    
    # Aider - Terminal warrior's dream, top SWE Bench score
    if command_exists aider; then
        DETECTED_AIS="$DETECTED_AIS aider"
        log "âœ“ Aider CLI detected"
    fi
    
    # Gemini CLI - Google's open-source terminal agent
    if command_exists gemini; then
        DETECTED_AIS="$DETECTED_AIS gemini"
        log "âœ“ Gemini CLI detected"
    fi
    
    # Warp - Agentic development environment terminal
    if command_exists warp; then
        DETECTED_AIS="$DETECTED_AIS warp"
        log "âœ“ Warp terminal detected"
    fi
    
    # Fabric - Open-source AI augmentation framework
    if command_exists fabric; then
        DETECTED_AIS="$DETECTED_AIS fabric"
        log "âœ“ Fabric CLI detected"
    fi
    
    # CodexCLI - OpenAI's terminal interface
    if command_exists codex || command_exists codes; then
        DETECTED_AIS="$DETECTED_AIS codex"
        log "âœ“ Codex CLI detected"
    fi
    
    # Ollama - Run AI models locally
    if command_exists ollama; then
        DETECTED_AIS="$DETECTED_AIS ollama"
        log "âœ“ Ollama detected"
    fi
    
    # Autopilot CLI (GitHub Copilot)
    if command_exists autopilot || command_exists github-copilot-cli || command_exists gh-copilot; then
        DETECTED_AIS="$DETECTED_AIS autopilot"
        log "âœ“ GitHub Copilot CLI detected"
    fi
    
    # GPT-5 Planner (ChatBot)
    if command_exists chatgpt || command_exists gpt || command_exists openai-chat; then
        DETECTED_AIS="$DETECTED_AIS gpt5-planner"
        log "âœ“ GPT-5 Planner (ChatBot) detected"
    fi
    
    if [ -z "$DETECTED_AIS" ]; then
        warn "No supported AI CLIs detected."
    else
        success "Detected AI CLIs: $DETECTED_AIS"
    fi
}

# Interactive AI CLI installation menu
install_missing_ai_clis() {
    if [ ! -z "$DETECTED_AIS" ]; then
        log "Found existing AI CLIs: $DETECTED_AIS"
        echo ""
    fi
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${PURPLE}ðŸ¤– Elite AI CLI Installation Menu${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BLUE}Choose which AI CLIs to install (based on elite developer preferences 2025):${NC}"
    echo ""
    
    # Define available AI tools with descriptions
    declare -A ai_tools
    ai_tools["claude-code"]="Claude Code - Anthropic's CLI with advanced reasoning"
    ai_tools["aider"]="Aider - Terminal warrior's dream, top SWE Bench score"
    ai_tools["gemini"]="Gemini CLI - Google's FREE terminal agent (1M token context, 60 req/min)"
    ai_tools["warp"]="Warp - Agentic development environment terminal"
    ai_tools["fabric"]="Fabric - Open-source AI augmentation framework"
    ai_tools["codex"]="Codex CLI - OpenAI's terminal interface"
    ai_tools["ollama"]="Ollama - Run AI models locally (free, private)"
    
    # Show installation options
    local install_choices=""
    
    if [ -t 0 ]; then
        # Interactive mode - prompt for each tool
        for tool in claude-code aider gemini warp fabric codex ollama; do
            if ! echo "$DETECTED_AIS" | grep -q "$tool"; then
                echo -e "${YELLOW}$tool${NC}: ${ai_tools[$tool]}"
                read -p "Install $tool? (y/N): " choice < /dev/tty
                if [[ $choice =~ ^[Yy]$ ]]; then
                    install_choices="$install_choices $tool"
                    success "âœ“ $tool selected for installation"
                else
                    log "Skipped $tool"
                fi
                echo ""
            fi
        done
        
        if [ -z "$install_choices" ]; then
            warn "No AI CLIs selected for installation"
            echo ""
            echo -e "${BLUE}ðŸ’¡ Recommendation: Install at least one AI CLI for NeuralSync functionality${NC}"
            read -p "Install recommended Claude Code? (Y/n): " default_choice < /dev/tty
            if [[ ! $default_choice =~ ^[Nn]$ ]]; then
                install_choices="claude-code"
            fi
        fi
    else
        # Piped mode - install essential free tools
        log "Running in piped mode - installing essential free AI CLIs..."
        for tool in claude-code aider gemini warp fabric codex ollama; do
            if ! echo "$DETECTED_AIS" | grep -q "$tool"; then
                case $tool in
                    "gemini"|"aider"|"ollama"|"fabric")
                        # Install free tools automatically
                        install_choices="$install_choices $tool"
                        log "âœ“ Auto-selected $tool (free tool)"
                        ;;
                    "claude-code")
                        # Install Claude Code as primary tool
                        install_choices="$install_choices $tool"
                        log "âœ“ Auto-selected $tool (primary CLI)"
                        ;;
                esac
            fi
        done
    fi
    
    # Install selected AI CLIs
    if [ ! -z "$install_choices" ]; then
        echo ""
        log "Installing selected AI CLIs: $install_choices"
        
        for tool in $install_choices; do
            install_ai_cli "$tool"
        done
    fi
}

# Install specific AI CLI
install_ai_cli() {
    local tool="$1"
    
    case "$tool" in
        "claude-code")
            log "Installing Claude Code..."
            case $OS_TYPE in
                "macOS")
                    if command_exists npm; then
                        npm install -g @anthropic/claude-cli || {
                            warn "npm install failed, trying direct download..."
                            curl -fsSL https://raw.githubusercontent.com/anthropics/claude-cli/main/install.sh | bash
                        }
                    else
                        curl -fsSL https://raw.githubusercontent.com/anthropics/claude-cli/main/install.sh | bash
                    fi
                    ;;
                "Linux")
                    curl -fsSL https://raw.githubusercontent.com/anthropics/claude-cli/main/install.sh | bash
                    ;;
            esac
            DETECTED_AIS="$DETECTED_AIS claude-code"
            ;;
            
        "aider")
            log "Installing Aider (Terminal warrior's dream)..."
            pip3 install --user aider-chat || {
                warn "pip install failed, trying alternative..."
                python3 -m pip install --user aider-chat
            }
            DETECTED_AIS="$DETECTED_AIS aider"
            ;;
            
        "gemini")
            log "Installing Gemini CLI (Google's open-source terminal agent)..."
            if command_exists npm; then
                npm install -g @google/gemini-cli || {
                    warn "Global npm install failed, trying without sudo..."
                    sudo npm install -g @google/gemini-cli
                }
            else
                log "Installing Node.js first..."
                case $OS_TYPE in
                    "macOS")
                        if command_exists brew; then
                            brew install node
                        else
                            curl -fsSL https://nodejs.org/dist/v20.11.0/node-v20.11.0.pkg -o /tmp/node.pkg
                            sudo installer -pkg /tmp/node.pkg -target /
                        fi
                        ;;
                    "Linux")
                        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                        sudo apt-get install -y nodejs
                        ;;
                esac
                npm install -g @google/gemini-cli
            fi
            DETECTED_AIS="$DETECTED_AIS gemini"
            ;;
            
        "warp")
            log "Installing Warp (Agentic development environment)..."
            case $OS_TYPE in
                "macOS")
                    if command_exists brew; then
                        brew install --cask warp || {
                            warn "brew install failed, downloading directly..."
                            curl -o /tmp/warp.dmg https://releases.warp.dev/stable/v0.2024.12.17.08.02.stable_01/Warp.dmg
                            log "Warp downloaded to /tmp/warp.dmg - please install manually"
                        }
                    else
                        curl -o /tmp/warp.dmg https://releases.warp.dev/stable/v0.2024.12.17.08.02.stable_01/Warp.dmg
                        log "Warp downloaded to /tmp/warp.dmg - please install manually"
                    fi
                    ;;
                "Linux")
                    warn "Warp is not officially supported on Linux yet. Skipping..."
                    return
                    ;;
            esac
            DETECTED_AIS="$DETECTED_AIS warp"
            ;;
            
        "fabric")
            log "Installing Fabric (Open-source AI augmentation framework)..."
            pip3 install --user fabric || {
                warn "pip install failed, trying from source..."
                git clone https://github.com/danielmiessler/fabric.git /tmp/fabric
                cd /tmp/fabric && pip3 install --user . && cd "$HOME"
                rm -rf /tmp/fabric
            }
            DETECTED_AIS="$DETECTED_AIS fabric"
            ;;
            
        "codex")
            log "Installing Codex CLI (OpenAI's terminal interface)..."
            pip3 install --user openai-codex-cli || {
                warn "openai-codex-cli not found, trying alternative..."
                npm install -g @openai/codex-cli || {
                    pip3 install --user codex-cli
                }
            }
            DETECTED_AIS="$DETECTED_AIS codex"
            ;;
            
        "ollama")
            log "Installing Ollama (Run AI models locally)..."
            case $OS_TYPE in
                "macOS")
                    if command_exists brew; then
                        brew install ollama
                    else
                        curl -fsSL https://ollama.ai/install.sh | sh
                    fi
                    ;;
                "Linux")
                    curl -fsSL https://ollama.ai/install.sh | sh
                    ;;
            esac
            
            # Start Ollama service
            log "Starting Ollama service..."
            ollama serve &
            sleep 5
            
            # Install a basic model
            log "Installing Ollama model (llama2)..."
            ollama pull llama2 || warn "Failed to pull model - you can do this later with: ollama pull llama2"
            
            DETECTED_AIS="$DETECTED_AIS ollama"
            ;;
            
        *)
            error "Unknown AI CLI: $tool"
            ;;
    esac
    
    # Verify installation
    local cmd=""
    case "$tool" in
        "claude-code") cmd="claude" ;;
        "aider") cmd="aider" ;;
        "gemini") cmd="gemini" ;;
        "warp") cmd="warp" ;;
        "fabric") cmd="fabric" ;;
        "codex") cmd="codex" ;;
        "ollama") cmd="ollama" ;;
    esac
    
    if command_exists "$cmd"; then
        success "âœ… $tool installed successfully"
    else
        warn "âš ï¸ $tool installation may have failed - check manually"
    fi
}

# Configure AI CLIs for unrestricted mode
configure_unrestricted_mode() {
    log "Configuring AI CLIs for unrestricted/permissionless mode..."
    
    # Create NeuralSync config directory
    mkdir -p "$INSTALL_DIR/config"
    
    # Configure Claude Code for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "claude-code"; then
        log "Configuring Claude Code for unrestricted mode..."
        
        # Create Claude Code config
        mkdir -p "$HOME/.claude"
        cat > "$HOME/.claude/config.json" << 'EOF'
{
  "api_key": "",
  "model": "claude-3-5-sonnet-20241022",
  "max_tokens": 8192,
  "temperature": 0.1,
  "restrictions": {
    "file_access": "unrestricted",
    "network_access": true,
    "system_commands": true,
    "package_install": true,
    "docker_access": true
  },
  "auto_approve": {
    "file_operations": true,
    "network_requests": true,
    "system_commands": false,
    "package_installs": false
  },
  "neuralsync": {
    "enabled": true,
    "endpoint": "http://localhost:8080",
    "token": ""
  }
}
EOF
        
        # Create unrestricted launch script
        cat > "$INSTALL_DIR/bin/claude-unrestricted" << 'EOF'
#!/bin/bash
export CLAUDE_UNRESTRICTED=1
export CLAUDE_AUTO_APPROVE=file_ops,network
export CLAUDE_NEURALSYNC_ENDPOINT=http://localhost:8080
claude "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/claude-unrestricted"
    fi
    
    # Configure CodexCLI for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "codexcli"; then
        log "Configuring CodexCLI for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/codex-unrestricted" << 'EOF'
#!/bin/bash
export CODEX_UNRESTRICTED=1
export CODEX_AUTO_EXECUTE=1
export CODEX_NEURALSYNC_ENDPOINT=http://localhost:8080
codex "$@" || codes "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/codex-unrestricted"
    fi
    
    # Configure Autopilot for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "autopilot"; then
        log "Configuring Autopilot for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/autopilot-unrestricted" << 'EOF'
#!/bin/bash
export GITHUB_COPILOT_UNRESTRICTED=1
export GH_COPILOT_AUTO_EXECUTE=1
export COPILOT_NEURALSYNC_ENDPOINT=http://localhost:8080
gh copilot "$@" || autopilot "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/autopilot-unrestricted"
    fi
    
    # Configure Aider for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "aider"; then
        log "Configuring Aider for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/aider-unrestricted" << 'EOF'
#!/bin/bash
export AIDER_UNRESTRICTED=1
export AIDER_AUTO_COMMITS=1
export AIDER_NO_SAFETY=1
export AIDER_NEURALSYNC_ENDPOINT=http://localhost:8080
aider --yes --auto-commits "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/aider-unrestricted"
    fi
    
    # Configure Google AI CLI for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "gemini"; then
        log "Configuring Google AI CLI for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/gemini-unrestricted" << 'EOF'
#!/bin/bash
export GOOGLE_AI_UNRESTRICTED=1
export GEMINI_AUTO_EXECUTE=1
export GEMINI_NEURALSYNC_ENDPOINT=http://localhost:8080
gemini "$@" || google-ai "$@" || gai "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/gemini-unrestricted"
    fi
    
    # Configure Warp for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "warp"; then
        log "Configuring Warp for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/warp-unrestricted" << 'EOF'
#!/bin/bash
export WARP_UNRESTRICTED=1
export WARP_AI_AUTO_EXECUTE=1
export WARP_NEURALSYNC_ENDPOINT=http://localhost:8080
warp "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/warp-unrestricted"
    fi
    
    # Configure Fabric for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "fabric"; then
        log "Configuring Fabric for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/fabric-unrestricted" << 'EOF'
#!/bin/bash
export FABRIC_UNRESTRICTED=1
export FABRIC_AUTO_EXECUTE=1
export FABRIC_NEURALSYNC_ENDPOINT=http://localhost:8080
fabric "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/fabric-unrestricted"
    fi
    
    # Configure Ollama for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "ollama"; then
        log "Configuring Ollama for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/ollama-unrestricted" << 'EOF'
#!/bin/bash
export OLLAMA_UNRESTRICTED=1
export OLLAMA_AUTO_EXECUTE=1
export OLLAMA_NEURALSYNC_ENDPOINT=http://localhost:8080
ollama "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/ollama-unrestricted"
    fi
    
    # Configure GPT-5 Planner (ChatBot) for unrestricted mode
    if echo "$DETECTED_AIS" | grep -q "gpt5-planner"; then
        log "Configuring GPT-5 Planner (ChatBot) for unrestricted mode..."
        
        cat > "$INSTALL_DIR/bin/gpt5-planner-unrestricted" << 'EOF'
#!/bin/bash
export CHATGPT_UNRESTRICTED=1
export GPT5_AUTO_EXECUTE=1
export GPT5_NEURALSYNC_ENDPOINT=http://localhost:8080
chatgpt "$@" || gpt "$@" || openai-chat "$@"
EOF
        chmod +x "$INSTALL_DIR/bin/gpt5-planner-unrestricted"
    fi
}

# Create Python virtual environment
create_python_venv() {
    log "Creating Python virtual environment..."
    
    if [ ! -d "$VENV_DIR" ]; then
        python3 -m venv "$VENV_DIR"
    fi
    
    source "$VENV_DIR/bin/activate"
    pip install --upgrade pip
    
    # Install Python dependencies for NeuralSync
    pip install fastapi uvicorn[standard] pydantic qdrant-client psycopg[binary] py2neo openai tiktoken python-jose[cryptography] websockets watchdog
    
    log "Python virtual environment created at $VENV_DIR"
}

# Create directory structure
create_directory_structure() {
    log "Creating NeuralSync directory structure..."
    
    mkdir -p "$INSTALL_DIR"/{bin,config,data,logs,agents,integrations}
    mkdir -p "$INSTALL_DIR/data"/{postgres,qdrant,neo4j,minio,api}
    
    success "Directory structure created at $INSTALL_DIR"
}

# Clone and setup NeuralSync from GitHub
clone_and_setup_neuralsync() {
    log "Cloning NeuralSync from GitHub..."
    
    # Check if we're already in a neuralsync directory or if files exist locally
    if [ -f "docker-compose.yml" ] && [ -d "services" ] && [ -d "bus" ]; then
        log "Found local NeuralSync files, using existing installation..."
        setup_local_files
    else
        log "Cloning from GitHub repository..."
        
        # Create temporary directory for cloning
        local temp_dir="/tmp/neuralsync-install-$$"
        git clone https://github.com/heyfinal/neuralsync.git "$temp_dir"
        
        if [ $? -eq 0 ]; then
            success "Repository cloned successfully"
            cd "$temp_dir"
            setup_local_files
            
            # Clean up temporary directory after copying
            cd "$HOME"
            rm -rf "$temp_dir"
        else
            error "Failed to clone repository. Check your internet connection."
            exit 1
        fi
    fi
}

# Setup files from local directory (whether cloned or existing)
setup_local_files() {
    log "Setting up NeuralSync files..."
    
    # Copy current directory files to install directory
    cp -r ./services "$INSTALL_DIR/" 2>/dev/null || true
    cp -r ./bus "$INSTALL_DIR/" 2>/dev/null || true
    cp -r ./bin/* "$INSTALL_DIR/bin/" 2>/dev/null || true
    cp -r ./agents "$INSTALL_DIR/" 2>/dev/null || true
    cp -r ./integrations "$INSTALL_DIR/" 2>/dev/null || true
    cp docker-compose.yml "$INSTALL_DIR/" 2>/dev/null || true
    cp docker-compose.enterprise.yml "$INSTALL_DIR/" 2>/dev/null || true
    cp .env.example "$INSTALL_DIR/.env" 2>/dev/null || true
    
    # Make all bin files executable
    chmod +x "$INSTALL_DIR/bin/"* 2>/dev/null || true
    
    # Create master launcher script with auto-launch capabilities
    create_master_launcher_script
    
    success "NeuralSync files configured"
}

# Create comprehensive master launcher script
create_master_launcher_script() {
    log "Creating NeuralSync master control script..."
    
    cat > "$INSTALL_DIR/bin/neuralsync" << 'EOF'
#!/bin/bash

# NeuralSync Master Control Script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="$(dirname "$SCRIPT_DIR")"
VENV_DIR="$INSTALL_DIR/venv"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

cd "$INSTALL_DIR"

case "$1" in
    start)
        echo -e "${BLUE}Starting NeuralSync...${NC}"
        source "$VENV_DIR/bin/activate" 2>/dev/null || true
        docker-compose up -d
        
        # Wait for services to be ready
        log "Waiting for services to start..."
        sleep 15
        
        # Verify API is running
        if curl -s http://localhost:8080/health >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… NeuralSync started successfully!${NC}"
            echo -e "${BLUE}API: http://localhost:8080${NC}"
            echo -e "${BLUE}Memory Dashboard: http://localhost:6333/dashboard${NC}"
            echo -e "${BLUE}Graph Explorer: http://localhost:7474${NC}"
        else
            warn "Services may still be starting. Check status with: neuralsync status"
        fi
        ;;
        
    autostart)
        echo -e "${BLUE}Auto-starting NeuralSync with AI agents...${NC}"
        source "$VENV_DIR/bin/activate" 2>/dev/null || true
        docker-compose up -d
        
        # Wait for services
        log "Waiting for core services..."
        sleep 20
        
        # Auto-launch detected AI agents in background
        log "Auto-launching AI agents..."
        
        # Launch Claude Code if available
        if command -v claude >/dev/null 2>&1; then
            log "Starting Claude Code agent..."
            nohup "$INSTALL_DIR/bin/claude-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/claude.pid"
        fi
        
        # Launch CodexCLI if available
        if command -v codex >/dev/null 2>&1 || command -v codes >/dev/null 2>&1; then
            log "Starting CodexCLI agent..."
            nohup "$INSTALL_DIR/bin/codex-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/codex.pid"
        fi
        
        # Launch Aider if available
        if command -v aider >/dev/null 2>&1; then
            log "Starting Aider agent..."
            nohup "$INSTALL_DIR/bin/aider-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/aider.pid"
        fi
        
        # Launch Warp if available
        if command -v warp >/dev/null 2>&1; then
            log "Starting Warp terminal..."
            nohup "$INSTALL_DIR/bin/warp-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/warp.pid"
        fi
        
        # Launch Fabric if available
        if command -v fabric >/dev/null 2>&1; then
            log "Starting Fabric..."
            nohup "$INSTALL_DIR/bin/fabric-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/fabric.pid"
        fi
        
        # Launch Ollama if available
        if command -v ollama >/dev/null 2>&1; then
            log "Starting Ollama..."
            nohup "$INSTALL_DIR/bin/ollama-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/ollama.pid"
        fi
        
        # Launch GPT-5 Planner (ChatBot) if available
        if command -v chatgpt >/dev/null 2>&1 || command -v gpt >/dev/null 2>&1; then
            log "Starting GPT-5 Planner (ChatBot)..."
            nohup "$INSTALL_DIR/bin/gpt5-planner-unrestricted" >/dev/null 2>&1 &
            echo $! > "$INSTALL_DIR/data/gpt5-planner.pid"
        fi
        
        echo -e "${GREEN}âœ… NeuralSync auto-started with AI agents!${NC}"
        "$0" status
        ;;
        
    stop)
        echo -e "${YELLOW}Stopping NeuralSync...${NC}"
        docker-compose down
        
        # Stop AI agent processes
        for pidfile in "$INSTALL_DIR/data/"*.pid; do
            if [ -f "$pidfile" ]; then
                pid=$(cat "$pidfile" 2>/dev/null)
                if [ ! -z "$pid" ] && kill -0 "$pid" 2>/dev/null; then
                    log "Stopping AI agent (PID: $pid)"
                    kill "$pid" 2>/dev/null || true
                fi
                rm -f "$pidfile"
            fi
        done
        
        echo -e "${GREEN}âœ… NeuralSync stopped${NC}"
        ;;
        
    restart)
        echo -e "${BLUE}Restarting NeuralSync...${NC}"
        "$0" stop
        sleep 5
        "$0" start
        ;;
        
    logs)
        if [ ! -z "$2" ]; then
            docker-compose logs -f "$2"
        else
            docker-compose logs -f
        fi
        ;;
        
    status)
        echo -e "${BLUE}NeuralSync Service Status:${NC}"
        docker-compose ps
        echo ""
        
        # Check API health
        if curl -s http://localhost:8080/health >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… API: Running (http://localhost:8080)${NC}"
        else
            echo -e "${RED}âŒ API: Not responding${NC}"
        fi
        
        # Check AI agent processes
        echo -e "${BLUE}AI Agent Status:${NC}"
        for pidfile in "$INSTALL_DIR/data/"*.pid; do
            if [ -f "$pidfile" ]; then
                agent_name=$(basename "$pidfile" .pid)
                pid=$(cat "$pidfile" 2>/dev/null)
                if [ ! -z "$pid" ] && kill -0 "$pid" 2>/dev/null; then
                    echo -e "${GREEN}âœ… $agent_name: Running (PID: $pid)${NC}"
                else
                    echo -e "${RED}âŒ $agent_name: Not running${NC}"
                    rm -f "$pidfile"
                fi
            fi
        done
        ;;
        
    health)
        # Comprehensive health check
        echo -e "${BLUE}NeuralSync Health Check:${NC}"
        
        # Check Docker
        if ! docker ps >/dev/null 2>&1; then
            echo -e "${RED}âŒ Docker: Not running${NC}"
            exit 1
        fi
        echo -e "${GREEN}âœ… Docker: Running${NC}"
        
        # Check services
        local services=("postgres" "qdrant" "neo4j" "api" "worker")
        for service in "${services[@]}"; do
            if docker-compose ps | grep -q "$service.*Up"; then
                echo -e "${GREEN}âœ… $service: Running${NC}"
            else
                echo -e "${RED}âŒ $service: Not running${NC}"
            fi
        done
        
        # Check API endpoint
        if curl -s http://localhost:8080/health | grep -q "ok"; then
            echo -e "${GREEN}âœ… API Health: OK${NC}"
        else
            echo -e "${RED}âŒ API Health: Failed${NC}"
        fi
        ;;
        
    ai)
        shift
        case "$1" in
            claude) 
                log "Launching Claude Code in unrestricted mode..."
                exec "$INSTALL_DIR/bin/claude-unrestricted" "${@:2}"
                ;;
            codex) 
                log "Launching CodexCLI in unrestricted mode..."
                exec "$INSTALL_DIR/bin/codex-unrestricted" "${@:2}"
                ;;
            autopilot) 
                log "Launching Autopilot in unrestricted mode..."
                exec "$INSTALL_DIR/bin/autopilot-unrestricted" "${@:2}"
                ;;
            aider) 
                log "Launching Aider in unrestricted mode..."
                exec "$INSTALL_DIR/bin/aider-unrestricted" "${@:2}"
                ;;
            gemini) 
                log "Launching Gemini in unrestricted mode..."
                exec "$INSTALL_DIR/bin/gemini-unrestricted" "${@:2}"
                ;;
            warp)
                log "Launching Warp in unrestricted mode..."
                exec "$INSTALL_DIR/bin/warp-unrestricted" "${@:2}"
                ;;
            fabric)
                log "Launching Fabric in unrestricted mode..."
                exec "$INSTALL_DIR/bin/fabric-unrestricted" "${@:2}"
                ;;
            ollama)
                log "Launching Ollama in unrestricted mode..."
                exec "$INSTALL_DIR/bin/ollama-unrestricted" "${@:2}"
                ;;
            gpt5-planner|chatgpt|planner)
                log "Launching GPT-5 Planner (ChatBot) in unrestricted mode..."
                exec "$INSTALL_DIR/bin/gpt5-planner-unrestricted" "${@:2}"
                ;;
            list)
                echo -e "${BLUE}Available AI CLIs (Elite Developer 2025 Edition):${NC}"
                command -v claude >/dev/null 2>&1 && echo -e "${GREEN}âœ… claude (Claude Code - Advanced Reasoning)${NC}" || echo -e "${RED}âŒ claude${NC}"
                command -v aider >/dev/null 2>&1 && echo -e "${GREEN}âœ… aider (Terminal Warrior - Top SWE Bench)${NC}" || echo -e "${RED}âŒ aider${NC}"
                command -v gemini >/dev/null 2>&1 && echo -e "${GREEN}âœ… gemini (Google AI - FREE, 1M Context)${NC}" || echo -e "${RED}âŒ gemini${NC}"
                command -v warp >/dev/null 2>&1 && echo -e "${GREEN}âœ… warp (Agentic Terminal)${NC}" || echo -e "${RED}âŒ warp${NC}"
                command -v fabric >/dev/null 2>&1 && echo -e "${GREEN}âœ… fabric (AI Augmentation Framework)${NC}" || echo -e "${RED}âŒ fabric${NC}"
                (command -v codex >/dev/null 2>&1 || command -v codes >/dev/null 2>&1) && echo -e "${GREEN}âœ… codex (OpenAI Terminal)${NC}" || echo -e "${RED}âŒ codex${NC}"
                command -v ollama >/dev/null 2>&1 && echo -e "${GREEN}âœ… ollama (Local AI Models)${NC}" || echo -e "${RED}âŒ ollama${NC}"
                command -v autopilot >/dev/null 2>&1 && echo -e "${GREEN}âœ… autopilot (GitHub Copilot)${NC}" || echo -e "${RED}âŒ autopilot${NC}"
                (command -v chatgpt >/dev/null 2>&1 || command -v gpt >/dev/null 2>&1) && echo -e "${GREEN}âœ… gpt5-planner (ChatBot)${NC}" || echo -e "${RED}âŒ gpt5-planner${NC}"
                ;;
            *) 
                echo "Usage: neuralsync ai {claude|aider|gemini|warp|fabric|codex|ollama|autopilot|gpt5-planner|list} [args]"
                echo "Use 'neuralsync ai list' to see available AI CLIs"
                ;;
        esac
        ;;
        
    config)
        if command -v nano >/dev/null 2>&1; then
            nano "$INSTALL_DIR/.env"
        elif command -v vim >/dev/null 2>&1; then
            vim "$INSTALL_DIR/.env"
        else
            echo "Opening config file with default editor..."
            "${EDITOR:-vi}" "$INSTALL_DIR/.env"
        fi
        ;;
        
    update)
        log "Updating NeuralSync..."
        
        # Pull latest Docker images
        docker-compose pull
        
        # Backup current config
        cp "$INSTALL_DIR/.env" "$INSTALL_DIR/.env.backup.$(date +%s)"
        
        # Try to update from git if in a git repo
        if [ -d "$INSTALL_DIR/.git" ]; then
            git -C "$INSTALL_DIR" pull origin main
        else
            warn "Not a git repository. Manual update required."
        fi
        
        log "Update complete. Restart services with: neuralsync restart"
        ;;
        
    install-cli)
        # Install missing AI CLIs
        shift
        case "$1" in
            claude)
                log "Installing Claude Code..."
                if command -v npm >/dev/null 2>&1; then
                    npm install -g @anthropic/claude-cli
                else
                    curl -fsSL https://raw.githubusercontent.com/anthropics/claude-cli/main/install.sh | bash
                fi
                ;;
            codex)
                log "Installing CodexCLI..."
                pip3 install --user openai-codex-cli
                ;;
            aider)
                log "Installing Aider..."
                pip3 install --user aider-chat
                ;;
            warp)
                log "Installing Warp terminal..."
                case "$OS_TYPE" in
                    "macOS")
                        brew install --cask warp || curl -o /tmp/warp.dmg https://releases.warp.dev/stable/v0.2024.12.17.08.02.stable_01/Warp.dmg
                        ;;
                    "Linux")
                        warn "Warp is not officially supported on Linux yet"
                        ;;
                esac
                ;;
            fabric)
                log "Installing Fabric..."
                pip3 install --user fabric
                ;;
            ollama)
                log "Installing Ollama..."
                curl -fsSL https://ollama.ai/install.sh | sh
                ;;
            gpt5-planner|chatgpt)
                log "Installing GPT-5 Planner (ChatBot)..."
                pip3 install --user chatgpt-cli
                ;;
            *)
                echo "Usage: neuralsync install-cli {claude|aider|gemini|warp|fabric|codex|ollama|gpt5-planner}"
                ;;
        esac
        ;;
        
    handoff)
        shift
        case "$1" in
            export)
                echo -e "${BLUE}Exporting memory for handoff...${NC}"
                thread_id="${2:-$(date +%Y%m%d_%H%M%S)}"
                export_file="$INSTALL_DIR/data/handoff_${thread_id}.nsync"
                
                # Create handoff bundle
                log "Creating handoff bundle: $export_file"
                tar -czf "$export_file" \
                    "$INSTALL_DIR/data/api/" \
                    "$INSTALL_DIR/config/base_memory.md" \
                    "$INSTALL_DIR/config/prime_directive.md" \
                    2>/dev/null || true
                
                echo -e "${GREEN}âœ… Handoff bundle created: $export_file${NC}"
                echo "Transfer this file to target device and import with:"
                echo "  neuralsync handoff import $export_file"
                ;;
                
            import)
                if [ -z "$2" ]; then
                    error "Usage: neuralsync handoff import <bundle_file>"
                    exit 1
                fi
                
                echo -e "${BLUE}Importing memory from handoff...${NC}"
                import_file="$2"
                
                if [ ! -f "$import_file" ]; then
                    error "Handoff bundle not found: $import_file"
                    exit 1
                fi
                
                # Backup current state
                backup_dir="$INSTALL_DIR/data/backup_$(date +%Y%m%d_%H%M%S)"
                mkdir -p "$backup_dir"
                cp -r "$INSTALL_DIR/data/api/" "$backup_dir/" 2>/dev/null || true
                
                # Import handoff bundle
                tar -xzf "$import_file" -C "/" 2>/dev/null || true
                
                echo -e "${GREEN}âœ… Memory imported successfully${NC}"
                echo "Restart services to apply: neuralsync restart"
                ;;
                
            status)
                echo -e "${BLUE}Handoff Status:${NC}"
                echo "Sync Mode: $(grep NEURALSYNC_SYNC_MODE "$INSTALL_DIR/.env" | cut -d'"' -f2)"
                echo ""
                echo "Available handoff bundles:"
                ls -lh "$INSTALL_DIR/data/"handoff_*.nsync 2>/dev/null || echo "  No handoff bundles found"
                ;;
                
            *)
                echo "Usage: neuralsync handoff {export|import|status}"
                echo ""
                echo "  export [thread_id] - Create handoff bundle"
                echo "  import <file>      - Import handoff bundle"
                echo "  status             - Show handoff status"
                ;;
        esac
        ;;
        
    sync)
        shift
        case "$1" in
            enable)
                log "Enabling real-time sync..."
                sed -i.bak 's/NEURALSYNC_SYNC_MODE=.*/NEURALSYNC_SYNC_MODE="realtime"/' "$INSTALL_DIR/.env"
                echo -e "${GREEN}âœ… Real-time sync enabled${NC}"
                echo "Restart services to apply: neuralsync restart"
                ;;
                
            disable)
                log "Disabling real-time sync..."
                sed -i.bak 's/NEURALSYNC_SYNC_MODE=.*/NEURALSYNC_SYNC_MODE="handoff"/' "$INSTALL_DIR/.env"
                echo -e "${GREEN}âœ… Real-time sync disabled (handoff mode only)${NC}"
                echo "Restart services to apply: neuralsync restart"
                ;;
                
            status)
                mode=$(grep NEURALSYNC_SYNC_MODE "$INSTALL_DIR/.env" | cut -d'"' -f2)
                echo -e "${BLUE}Sync Status:${NC}"
                case "$mode" in
                    realtime)
                        echo -e "${GREEN}âœ… Real-time sync: ENABLED${NC}"
                        echo "Memories sync continuously across devices"
                        ;;
                    handoff)
                        echo -e "${YELLOW}âš ï¸ Real-time sync: DISABLED${NC}"
                        echo "Manual handoff mode - use 'neuralsync handoff' commands"
                        ;;
                    hybrid)
                        echo -e "${GREEN}âœ… Hybrid mode: ENABLED${NC}"
                        echo "Both real-time sync and manual handoff available"
                        ;;
                esac
                
                # Check NAS status if in realtime mode
                if [ "$mode" = "realtime" ] || [ "$mode" = "hybrid" ]; then
                    echo ""
                    nas_mount=$(grep NEURALSYNC_NAS_MOUNT_POINT "$INSTALL_DIR/.env" | cut -d'"' -f2)
                    if [ ! -z "$nas_mount" ] && [ -d "$nas_mount" ]; then
                        echo -e "${GREEN}âœ… NAS: Connected ($nas_mount)${NC}"
                    else
                        echo -e "${YELLOW}âš ï¸ NAS: Not configured or unavailable${NC}"
                    fi
                fi
                ;;
                
            *)
                echo "Usage: neuralsync sync {enable|disable|status}"
                echo ""
                echo "  enable  - Enable real-time synchronization"
                echo "  disable - Use manual handoff only"
                echo "  status  - Show current sync configuration"
                ;;
        esac
        ;;
        
    *)
        echo -e "${BLUE}NeuralSync Control Panel${NC}"
        echo "Usage: neuralsync {command} [options]"
        echo ""
        echo -e "${YELLOW}Core Commands:${NC}"
        echo "  start       - Start NeuralSync services"
        echo "  autostart   - Start services + auto-launch AI agents"
        echo "  stop        - Stop NeuralSync services and AI agents"
        echo "  restart     - Restart NeuralSync services"
        echo "  status      - Show service and AI agent status"
        echo "  health      - Comprehensive health check"
        echo ""
        echo -e "${YELLOW}Memory Sync:${NC}"
        echo "  sync        - Manage real-time synchronization"
        echo "  handoff     - Export/import memory bundles"
        echo ""
        echo -e "${YELLOW}AI Integration:${NC}"
        echo "  ai <name>   - Launch AI CLI in unrestricted mode"
        echo "  ai list     - Show available AI CLIs"
        echo ""
        echo -e "${YELLOW}Management:${NC}"
        echo "  logs [svc]  - Show service logs"
        echo "  config      - Edit configuration"
        echo "  update      - Update NeuralSync"
        echo "  install-cli - Install missing AI CLIs"
        echo ""
        echo -e "${YELLOW}Quick Start:${NC}"
        echo "  neuralsync autostart      # Start everything automatically"
        echo "  neuralsync handoff export # Create memory bundle for transfer"
        echo "  neuralsync ai claude      # Launch Claude in unrestricted mode"
        ;;
esac
EOF
    chmod +x "$INSTALL_DIR/bin/neuralsync"
    
    success "NeuralSync files configured"
}

# Add to PATH
setup_path() {
    log "Setting up PATH..."
    
    # Add to bash profile
    if [ -f "$HOME/.bashrc" ]; then
        echo "export PATH=\"$INSTALL_DIR/bin:\$PATH\"" >> "$HOME/.bashrc"
    fi
    
    if [ -f "$HOME/.bash_profile" ]; then
        echo "export PATH=\"$INSTALL_DIR/bin:\$PATH\"" >> "$HOME/.bash_profile"
    fi
    
    # Add to zsh profile
    if [ -f "$HOME/.zshrc" ]; then
        echo "export PATH=\"$INSTALL_DIR/bin:\$PATH\"" >> "$HOME/.zshrc"
    fi
    
    # Export for current session
    export PATH="$INSTALL_DIR/bin:$PATH"
    
    success "NeuralSync added to PATH"
}

# Configure environment variables
configure_environment() {
    log "Configuring environment variables..."
    
    # Generate API token
    API_TOKEN=$(openssl rand -hex 32 2>/dev/null || python3 -c "import secrets; print(secrets.token_hex(32))")
    
    # Hash admin password
    ADMIN_PASS_HASH=$(echo -n "$NEURALSYNC_ADMIN_PASS" | sha256sum | awk '{print $1}' 2>/dev/null || echo -n "$NEURALSYNC_ADMIN_PASS" | shasum -a 256 | awk '{print $1}')
    
    # Update .env file with all configurations
    sed -i.bak "s/NEURALSYNC_API_TOKEN=.*/NEURALSYNC_API_TOKEN=$API_TOKEN/" "$INSTALL_DIR/.env"
    
    # Add user and admin configurations
    cat >> "$INSTALL_DIR/.env" << EOF

# User Configuration
NEURALSYNC_USER_NAME="$USER_NAME"
NEURALSYNC_ADMIN_USER="$NEURALSYNC_ADMIN_USER"
NEURALSYNC_ADMIN_PASS_HASH="$ADMIN_PASS_HASH"

# Sync Mode Configuration
NEURALSYNC_SYNC_MODE="$NEURALSYNC_SYNC_MODE"

# NAS Configuration
EOF
    
    if [ ! -z "$NAS_MOUNT_POINT" ]; then
        echo "NEURALSYNC_NAS_MOUNT_POINT=\"$NAS_MOUNT_POINT\"" >> "$INSTALL_DIR/.env"
    fi
    
    if [ ! -z "$NAS_IP" ]; then
        echo "NEURALSYNC_NAS_IP=\"$NAS_IP\"" >> "$INSTALL_DIR/.env"
        echo "NEURALSYNC_NAS_USERNAME=\"$NAS_USERNAME\"" >> "$INSTALL_DIR/.env"
        echo "NEURALSYNC_NAS_PASSWORD=\"$NAS_PASSWORD\"" >> "$INSTALL_DIR/.env"
    fi
    
    # Ask for AI API keys
    echo ""
    echo -e "${BLUE}ðŸ”‘ AI Provider API Keys${NC}"
    echo "Configure API keys for AI providers (optional but recommended):"
    echo ""
    
    if [ -t 0 ]; then
        read -p "Enter OpenAI API Key (optional, press Enter to skip): " openai_key < /dev/tty
        if [ ! -z "$openai_key" ]; then
            sed -i.bak "s/OPENAI_API_KEY=.*/OPENAI_API_KEY=$openai_key/" "$INSTALL_DIR/.env"
        fi
        
        read -p "Enter Anthropic API Key (optional, press Enter to skip): " anthropic_key < /dev/tty
        if [ ! -z "$anthropic_key" ]; then
            echo "ANTHROPIC_API_KEY=$anthropic_key" >> "$INSTALL_DIR/.env"
        fi
        
        read -p "Enter Google AI API Key (optional, press Enter to skip): " google_key < /dev/tty
        if [ ! -z "$google_key" ]; then
            echo "GOOGLE_AI_API_KEY=$google_key" >> "$INSTALL_DIR/.env"
        fi
    else
        log "Skipping API key configuration in piped mode - configure later with: neuralsync config"
    fi
    
    success "Environment configured with personalized settings"
}

# Final setup with auto-start capability
final_setup_with_autostart() {
    log "Performing final setup..."
    
    cd "$INSTALL_DIR"
    
    # Pull Docker images
    log "Pulling Docker images..."
    source "$VENV_DIR/bin/activate"
    docker-compose pull
    
    # Ask user if they want to auto-start everything
    echo ""
    echo -e "${BLUE}ðŸš€ Auto-Start Configuration${NC}"
    echo "Would you like to automatically start NeuralSync and launch AI agents?"
    echo "This will:"
    echo "  â€¢ Start all NeuralSync services (Docker containers)"
    echo "  â€¢ Launch detected AI agents in the background"
    echo "  â€¢ Verify everything is working"
    echo ""
    if [ -t 0 ]; then
        read -p "Auto-start NeuralSync now? (Y/n): " auto_start < /dev/tty
    else
        auto_start="y"
        log "Auto-starting NeuralSync in piped mode"
    fi
    
    if [[ ! $auto_start =~ ^[Nn]$ ]]; then
        log "Auto-starting NeuralSync with all detected AI agents..."
        
        # Use the neuralsync command for auto-start
        "$INSTALL_DIR/bin/neuralsync" autostart
        
        success "NeuralSync auto-started successfully!"
        
        echo ""
        echo -e "${GREEN}ðŸŽ¯ Quick Commands:${NC}"
        echo -e "  ${BLUE}neuralsync status${NC}      - Check system status"
        echo -e "  ${BLUE}neuralsync ai claude${NC}   - Launch Claude Code"
        echo -e "  ${BLUE}neuralsync ai gemini${NC}   - Launch Gemini CLI (FREE)"
        echo -e "  ${BLUE}neuralsync ai list${NC}     - Show available AIs"
        echo -e "  ${BLUE}neuralsync health${NC}      - Full system health check"
        
    else
        log "Skipping auto-start. You can start manually with: neuralsync autostart"
        
        # Just test that we can pull images and basic setup works
        log "Testing basic setup..."
        docker-compose up -d --no-deps postgres qdrant neo4j
        sleep 10
        docker-compose down
        
        success "Basic setup verified!"
    fi
    
    success "NeuralSync installation complete!"
}

# Main installation flow
main() {
    log "Starting NeuralSync installation..."
    
    detect_os
    detect_package_managers
    get_user_preferences
    install_system_dependencies
    detect_ai_clis
    install_missing_ai_clis
    scan_ai_configurations
    create_directory_structure
    create_python_venv
    compile_base_memory
    configure_unrestricted_mode
    clone_and_setup_neuralsync
    setup_path
    configure_environment
    final_setup_with_autostart
    
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}ðŸŽ‰ NeuralSync Installation Complete! ðŸŽ‰${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Installation Directory:${NC} $INSTALL_DIR"
    echo -e "${YELLOW}Detected AI CLIs:${NC} $DETECTED_AIS"
    echo -e "${YELLOW}API Endpoint:${NC} http://localhost:8080"
    echo ""
    echo -e "${PURPLE}Quick Start Commands:${NC}"
    echo -e "  ${BLUE}neuralsync status${NC}     - Check service status"
    echo -e "  ${BLUE}neuralsync logs${NC}       - View service logs"
    echo -e "  ${BLUE}neuralsync ai claude${NC}  - Launch Claude in unrestricted mode"
    echo -e "  ${BLUE}neuralsync config${NC}     - Edit configuration"
    echo ""
    echo -e "${GREEN}Restart your terminal or run:${NC} source ~/.bashrc"
    echo ""
    echo -e "${CYAN}Happy AI orchestration! ðŸ¤–${NC}"
}

# Run installation
main "$@"